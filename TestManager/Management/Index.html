<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Test Manager</title>
</head>
<body>
    <h2 class="title">Test Manager</h2>
    <div class="container" v-scope @vue:mounted="mounted">
        <div class="left section">
            <h3>
                Path: /{{ currentPath }}
            </h3>
            <div class="fileentry up" @click="up()">
                [folder] <span class="name">..</span> 
            </div>
            <div class="fileentry" :class="file.type" v-for="file in files" @click="load(file)">
                [{{ file.type }}]<span class="name">{{ file.name }}</span>
            </div>
        </div>
        <div class="right section" v-if="activeFile != null">
            <!-- {{ activeFile }} -->
            <div class="button-group flex-w-full">
                <button @click="run()">Run Test(s)<br />(Make sure to save)</button>
                <button @click="save()">Save</button>
                <button @click="cancel()">Reload</button>
            </div>
            
            <h3>Add new Tests</h3>

            <div class="button-group">
                <button v-for="handler in activeFile.availableHandlers" @click="addHandler(handler)">
                    Add {{ handler.name }}
                </button>
            </div>

            <div class="handler" v-for="(handler, index) in activeFile.currentHandlers">
                <h4>
                    {{ handler.name }}

                    <button class="float-right" @click="removeHandler(index)">Remove</button>
                </h4>
                <div v-for="param in handler.parameters">
                    <div> {{ param.name }}</div>
                    <textarea type="text" v-model="param.value" ></textarea>
                </div>
            </div>
        </div>
        <div class="bottom section">
            <pre>{{ runResults }}</pre>
        </div>
    </div>
    
    
    
    
    
    
    <script type="module">
        import { createApp } from 'https://unpkg.com/petite-vue?module'
      
        createApp({
          files: [],
          activeFile: null,
          loadedFile: "",
          currentPath: "",
          runResults: "",
          mounted() {
            this.getFiles();
            this.runResults = `
            TODOs
            - Allow bulk running from UI
            - Test Case integration configured got config file in root directory
            - Copy to clipboard for run result
            - Tabs on result section to view result friendlier (more per line)
            - Readme documentation
            - Create/Delete tsjson files for normal files
            - Basic text editor for text files
            - Copy full path of file on disk to clipboard
            ` 
          },
          load(file) {
            if (file.type == "testfile")
            {
                this.loadedFile = this.currentPath == "" ? file.name : this.currentPath + "/" + file.name;
                fetch("http://localhost:5000/load?file="+this.loadedFile)
                    .then((data) => data.json())
                    .then(res => this.activeFile = res);
            }
            if (file.type == "folder")
            {
                this.activeFile = null;
                this.runResults = "";
                this.loadedFile = "";
                this.currentPath += file.name + "/";
                this.getFiles();
            }

          },
          save() {
            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            fetch("http://localhost:5000/save?file="+this.loadedFile, 
                {
                    method: "POST",
                    body: JSON.stringify(this.activeFile.currentHandlers),
                    headers: myHeaders,
                });
          },
          getFiles() {
            fetch("http://localhost:5000/get-files" + (this.currentPath == "" ? "" : "?path=" + this.currentPath))
                .then((data) => data.json())
                .then(res => this.files = res);
          },
          up() {
            this.activeFile = null;
            this.runResults = "";
            this.loadedFile = "";
            do 
            {
                this.currentPath = this.currentPath.slice(0, -1);
            } while (!this.currentPath.endsWith("/") && this.currentPath != "");
            this.getFiles();
          },
          addHandler(handler) {
            this.activeFile.currentHandlers.unshift(JSON.parse(JSON.stringify(handler)))
          },
          removeHandler(index) {
            this.activeFile.currentHandlers.splice(index, 1);
          },
          run() {
            fetch("http://localhost:5000/run?file="+this.loadedFile, 
                {
                    method: "POST"
                })                
                .then(data => data.json())
                .then(res => this.runResults = JSON.stringify(res, null, 2));
          },
          cancel() {
                fetch("http://localhost:5000/load?file="+this.loadedFile)
                    .then((data) => data.json())
                    .then(res => this.activeFile = res);
          }
        }).mount()
      </script>
    <style>
        body, html {
            padding: 0;
            margin: 0;
            font-family: system-ui;
            --clr-bg: #121212;
            --clr-bg2: #282828;
            --clr-font: #cacaca;
            --clr-accent: #23c73e;
            --clr-dark-accent: #18741d;
            color: var(--clr-font);
            font-size: larger;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 3fr 1fr;
            height: 100vh;
            width: 100%;
            align-content: stretch;
            background-color: var(--clr-bg);
        }

        .section {
            border: 1px solid var(--clr-accent);
            overflow-y: scroll;
            padding: 0.5rem;
        }

        .bottom {
            grid-column: span 2;
        }

        .testfile, .folder, .up {
            cursor: pointer;
        }

        .file {
            cursor: default;
        }

        .fileentry {
            position: relative;
            margin-bottom: 0.2rem;
            box-sizing: border-box;
            transition: scale 0.1s linear;
        }

        .fileentry .name {
            position: absolute;
            left: 5rem;
        }

        .fileentry:nth-child(odd) {
            background-color: var(--clr-bg2);
        }

        .fileentry:hover {
            border: 1px solid var(--clr-accent);
            scale: 102%;
        }

        .title {
            background-color: var(--clr-bg);
            text-align: center;
            margin: 0;
            padding: 1.5rem;
            color: var(--clr-accent);
        }

        button {
            background-color: var(--clr-dark-accent); /* Green */
            border: none;
            color: var(--clr-font);
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            transition: all .1s ease-in;
            font-size: inherit;
        }

        button:hover {
            filter: brightness(80%);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            align-items: stretch;
        }

        .mb-1 {
            margin-bottom: 1rem;
        }

        .float-right {
            float: right;
        }

        .handler {
            border-top: 1px solid var(--clr-accent);
            margin-top: 0.5rem;
        }

        .handler h4 {
            margin-top: 0.25rem;
        }

        .handler textarea {
            font-size: larger;
            width: 550px;
            min-width: 550px;
            color: var(--clr-font);
            background-color: var(--clr-bg2);
        }

        .flex-w-full > * {
            flex: 1 0 auto;
        }
    </style>
</body>
</html>